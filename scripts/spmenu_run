#!/bin/sh
[ -z "$TERMINAL" ] && TERMINAL="st -e"
[ -z "$BROWSER"  ] && BROWSER="xdg-open"
[ -z "$TORRENT"  ] && TORRENT="qbittorrent"
[ -z "$HISTORY" ] && HISTORY="${XDG_CACHE_HOME:-$HOME/.cache/}/spmenu_run.hist"

path() { echo "$PATH" | tr ':' '\n' | uniq | sed 's#$#/#' | xargs ls -lu --time-style=+%s 2>&1 | awk '/^(-|l)/ { print $6, $7 }' | sort -rn | cut -d' ' -f 2 2>&1; }

# run spmenu and parse it
parse() {
    dout="$(path | sed "s/\&/\&amp;/g" | spmenu --insert --hist-file "$HISTORY" "$@")"

    # parse
    [ "$(printf '%c' "$dout")" = "#" ] && RUN_ARG="$TERMINAL"
    [ "$(printf "$dout" | awk '{ print $1 }')" = "magnet" ] && "$TORRENT" "$(printf "$dout" | sed "s/magnet //")"
    [ "$(printf "$dout" | awk '{ print $1 }')" = "www" ] && "$BROWSER" "$(printf "$dout" | sed "s/www //")"

    # terminal
    [ -z "$RUN_ARG" ] && \
        printf "%s" "$dout" | sed "s/#//g" | ${SHELL:-"/bin/sh"} &

    [ "$RUN_ARG" = "$TERMINAL" ] && $TERMINAL -e "$(printf "%s" "$dout" | sed "s/#//g")"; return
}

main() {
    parse "$@"
    rm -f "$HOME/.cache/spmenu_run"
}

main "$@"
